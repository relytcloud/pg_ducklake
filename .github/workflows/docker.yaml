name: Build Docker

permissions:
  id-token: write
  contents: write

on:
  push:
    tags: ["v*"]
  pull_request:
    paths:
      - Dockerfile
      - docker-bake.hcl
      - ".github/workflows/docker.yaml"
  schedule:
    - cron: "44 4 * * *"
  workflow_dispatch:

jobs:
  docker_build:
    name: Build Docker image for Postgres ${{ matrix.postgres }} on ${{ matrix.runner }}
    strategy:
      matrix:
        postgres: ["14", "15", "16", "17", "18"]
        runner: ["ubuntu-24.04", "ubuntu-24.04-arm"]

    runs-on: ${{ matrix.runner }}

    env:
      BUILDKIT_PROGRESS: plain
      POSTGRES_VERSION: ${{ matrix.postgres }}
    outputs:
      branch_tag: ${{ steps.params.outputs.branch_tag }}
      target_repo: ${{ steps.params.outputs.target_repo }}
    steps:
      - name: Login to Docker Hub
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        uses: docker/login-action@v3
        with:
          username: pgducklake
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Checkout pg_ducklake extension code
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Compute job parameters
        id: params
        run: |
          # Tag is XX-YYYYY-<branch>-latest so 16 + branch name length
          # since maximum docker tag is 128 characters, we need to truncate the branch name to 112
          BRANCH=$(echo "${{ github.head_ref || github.ref_name }}" \
              | sed 's/[^a-zA-Z0-9\-\.]/-/g' \
              | cut -c 1-112 | tr '[:upper:]' '[:lower:]' \
              | sed -e 's/-*$//')

          # Set platform depending on which runner we're using
          if [ "${{ matrix.runner }}" = "ubuntu-24.04" ]; then
            PLATFORM=amd64
          else
            PLATFORM=arm64
          fi

          # If main or tag, then push to `pgducklake/pgducklake`
          git fetch --tags --force --no-recurse-submodules
          if [ "$BRANCH" = "main" ] || git rev-parse --verify $BRANCH^{tag} > /dev/null 2>&1; then
            TARGET_REPO='pgducklake/pgducklake'
          else
            TARGET_REPO='pgducklake/ci-builds'
          fi

          echo "platform=$PLATFORM" >> "$GITHUB_OUTPUT"
          echo "branch_tag=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "target_repo=$TARGET_REPO" >> "$GITHUB_OUTPUT"
          echo "latest_image=pgducklake/ci-builds:${{ matrix.postgres }}-${PLATFORM}-${BRANCH}-latest" >> "$GITHUB_OUTPUT"

      - name: Attempt to pull previous image
        run: |
          docker pull ${{ steps.params.outputs.latest_image }} || true
          docker pull moby/buildkit:buildx-stable-1

      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/${{ steps.params.outputs.platform }}

      - name: docker bake
        uses: docker/bake-action@v5
        with:
          targets: pg_ducklake_${{ matrix.postgres }}
          push: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
          set: |
            *.platform=linux/${{ steps.params.outputs.platform }}
            *.cache-from=type=registry,ref=${{ steps.params.outputs.latest_image }}
            *.cache-from=type=gha,scope=${{ github.workflow }}
            *.cache-to=type=gha,mode=max,scope=${{ github.workflow }}
            postgres.tags=pgducklake/ci-builds:${{ matrix.postgres }}-${{ steps.params.outputs.platform }}-${{ github.sha }}
            postgres.tags=${{ steps.params.outputs.latest_image }}

  docker_merge:
    name: Merge Docker image for Postgres ${{ matrix.postgres }}
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    strategy:
      matrix:
        postgres: ["14", "15", "16", "17", "18"]

    runs-on: ubuntu-24.04
    needs: docker_build
    steps:
      - name: Login to Docker Hub
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        uses: docker/login-action@v3
        with:
          username: pgducklake
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Merge images
        run: |
          docker pull --platform linux/amd64 pgducklake/ci-builds:${{ matrix.postgres }}-amd64-${{ github.sha }}
          docker pull --platform linux/arm64 pgducklake/ci-builds:${{ matrix.postgres }}-arm64-${{ github.sha }}

          BRANCH="${{ needs.docker_build.outputs.branch_tag }}"

          echo "Merging multi-arch image to ci-builds."
          docker buildx imagetools create \
            --tag pgducklake/ci-builds:${{ matrix.postgres }}-${BRANCH}         \
            --tag pgducklake/ci-builds:${{ matrix.postgres }}-${{ github.sha }} \
            pgducklake/ci-builds:${{ matrix.postgres }}-amd64-${{ github.sha }} \
            pgducklake/ci-builds:${{ matrix.postgres }}-arm64-${{ github.sha }}

          docker buildx imagetools inspect pgducklake/ci-builds:${{ matrix.postgres }}-${{ github.sha }}

  clickbench_test:
    name: ClickBench for Postgres ${{ matrix.postgres }} on ${{ matrix.platform }}
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        postgres: ["14", "15", "16", "17", "18"]
        platform: ["amd64", "arm64"]
      fail-fast: false

    runs-on: ${{ matrix.platform == 'amd64' && 'ubuntu-24.04' || 'ubuntu-24.04-arm' }}
    needs: docker_merge

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: pgducklake
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Checkout ClickBench repository
        uses: actions/checkout@v4
        with:
          repository: ClickHouse/ClickBench
          path: clickbench

      - name: Pull test image
        run: |
          docker pull pgducklake/ci-builds:${{ matrix.postgres }}-${{ github.sha }}

      - name: Run ClickBench
        working-directory: clickbench/pg_ducklake
        run: |
          # Replace docker image in benchmark.sh with our test image
          sed -i "s|pgducklake/pgducklake:18-main|pgducklake/ci-builds:${{ matrix.postgres }}-${{ github.sha }}|g" benchmark.sh

          chmod +x benchmark.sh
          ./benchmark.sh 2>&1 | tee benchmark.log

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clickbench-results-pg${{ matrix.postgres }}-${{ matrix.platform }}
          path: |
            clickbench/pg_ducklake/benchmark.log
            clickbench/pg_ducklake/log.txt

  docker_promote:
    name: Promote Docker image for Postgres ${{ matrix.postgres }}
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        postgres: ["14", "15", "16", "17", "18"]

    runs-on: ubuntu-24.04
    needs: clickbench_test

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: pgducklake
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine target repository
        id: target
        run: |
          # If main or tag, promote to pgducklake/pgducklake
          git init
          git remote add origin https://github.com/${{ github.repository }}
          git fetch --tags --no-recurse-submodules origin ${{ github.ref }}

          BRANCH=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9\-\.]/-/g' | tr '[:upper:]' '[:lower:]')

          if [ "${{ github.ref }}" = "refs/heads/main" ] || git rev-parse --verify ${BRANCH}^{tag} > /dev/null 2>&1; then
            TARGET_REPO='pgducklake/pgducklake'
          else
            TARGET_REPO='pgducklake/ci-builds'
          fi

          echo "target_repo=$TARGET_REPO" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Promote multi-arch image
        run: |
          TARGET_REPO="${{ steps.target.outputs.target_repo }}"
          BRANCH="${{ steps.target.outputs.branch }}"

          echo "Promoting image to ${TARGET_REPO}:${{ matrix.postgres }}-${BRANCH}"

          docker buildx imagetools create \
            --tag ${TARGET_REPO}:${{ matrix.postgres }}-${BRANCH} \
            pgducklake/ci-builds:${{ matrix.postgres }}-${{ github.sha }}

          docker buildx imagetools inspect ${TARGET_REPO}:${{ matrix.postgres }}-${BRANCH}
