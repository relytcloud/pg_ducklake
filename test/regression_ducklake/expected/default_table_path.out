-- Test ducklake.default_table_path GUC
-- This test verifies that tables are created in custom paths when the GUC is set

-- Initialize DuckLake
SELECT ducklake.create_metadata();
NOTICE:  No data path provided, using default: DataDir/pg_ducklake
NOTICE:  schema "ducklake" already exists, skipping
 create_metadata
-----------------

(1 row)

-- Test 1: Create table without GUC set (should use default path)
CREATE TABLE test_default_path (i INT, j VARCHAR) USING ducklake;

-- Verify the table path uses default DuckLake data directory
SELECT
    table_name,
    path,
    path_is_relative,
    substring(path from 1 for 50) as path_prefix
FROM ducklake.ducklake_table
WHERE table_name = 'test_default_path';
   table_name     |        path        | path_is_relative |    path_prefix
-------------------+--------------------+------------------+--------------------
 test_default_path | test_default_path/ | t                | test_default_path/
(1 row)

-- Test 2: Set custom path and create table
SET ducklake.default_table_path = '/tmp/ducklake_custom_tables';
CREATE TABLE test_custom_path (i INT, j VARCHAR) USING ducklake;

-- Verify the table path uses custom path
SELECT
    table_name,
    path,
    path_is_relative,
    starts_with(path, '/tmp/ducklake_custom_tables') as uses_custom_path
FROM ducklake.ducklake_table
WHERE table_name = 'test_custom_path';
   table_name    |                        path                         | path_is_relative | uses_custom_path
------------------+----------------------------------------------------+------------------+------------------
 test_custom_path | /tmp/ducklake_custom_tables/main/test_custom_path/ | f                | t
(1 row)

-- Test 3: Insert data and verify it works
INSERT INTO test_custom_path VALUES (1, 'one'), (2, 'two');
SELECT * FROM test_custom_path ORDER BY i;
 i |  j
---+-----
 1 | one
 2 | two
(2 rows)

-- Test 4: CTAS with custom path
CREATE TABLE test_ctas_custom_path AS SELECT * FROM test_custom_path;

-- Verify CTAS table also uses custom path
SELECT
    table_name,
    path,
    starts_with(path, '/tmp/ducklake_custom_tables') as uses_custom_path
FROM ducklake.ducklake_table
WHERE table_name = 'test_ctas_custom_path';
     table_name       |                        path                         | path_is_relative | uses_custom_path
-----------------------+----------------------------------------------------+------------------+------------------
 test_ctas_custom_path | /tmp/ducklake_custom_tables/main/test_ctas_custom_path/ | f                | t
(1 row)

-- Verify data was copied
SELECT * FROM test_ctas_custom_path ORDER BY i;
 i |  j
---+-----
 1 | one
 2 | two
(2 rows)

-- Test 5: Change path to another location
SET ducklake.default_table_path = '/tmp/ducklake_another_location';
CREATE TABLE test_another_path (i INT) USING ducklake;

-- Verify the new table uses the new path
SELECT
    table_name,
    path,
    starts_with(path, '/tmp/ducklake_another_location') as uses_another_path
FROM ducklake.ducklake_table
WHERE table_name = 'test_another_path';
   table_name      |                       path                        | uses_another_path
------------------+----------------------------------------------------+-------------------
 test_another_path | /tmp/ducklake_another_location/main/test_another_path/ | f
(1 row)

-- Test 6: Reset to empty string (should use default path)
SET ducklake.default_table_path = '';
CREATE TABLE test_reset_path (i INT) USING ducklake;

-- Verify the table uses default path again
SELECT
    table_name,
    path,
    path_is_relative
FROM ducklake.ducklake_table
WHERE table_name = 'test_reset_path';
  table_name    |       path       | path_is_relative
----------------+------------------+------------------
 test_reset_path | test_reset_path/ | t
(1 row)

-- Test 7: Verify all tables created
SELECT
    table_name,
    substring(path from 1 for 60) as path_prefix,
    path_is_relative
FROM ducklake.ducklake_table
WHERE table_name LIKE 'test_%'
ORDER BY table_name;
    table_name       |                    path_prefix                     | path_is_relative
----------------------+----------------------------------------------------+------------------
 test_another_path  | /tmp/ducklake_another_location/main/test_another_path/ | f
 test_ctas_custom_path | /tmp/ducklake_custom_tables/main/test_ctas_custom_path/ | f
 test_custom_path   | /tmp/ducklake_custom_tables/main/test_custom_path/     | f
 test_default_path  | test_default_path/                                | t
 test_reset_path    | test_reset_path/                                  | t
(5 rows)

-- Cleanup
DROP TABLE test_default_path;
DROP TABLE test_custom_path;
DROP TABLE test_ctas_custom_path;
DROP TABLE test_another_path;
DROP TABLE test_reset_path;
SELECT ducklake.drop_metadata(true);
WARNING:  Deleting all ducklake files
 drop_metadata
---------------

(1 row)
