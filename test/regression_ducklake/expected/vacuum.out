-- Test VACUUM on DuckLake tables
-- Scenario 1: Merge adjacent files
CREATE TABLE vacuum_merge (a int, b text) USING ducklake;
-- Create multiple parquet files
INSERT INTO vacuum_merge VALUES (1, 'one');
INSERT INTO vacuum_merge VALUES (2, 'two');
INSERT INTO vacuum_merge VALUES (3, 'three');
INSERT INTO vacuum_merge VALUES (4, 'four');
INSERT INTO vacuum_merge VALUES (5, 'five');
SELECT * FROM vacuum_merge ORDER BY a;
 a |   b   
---+-------
 1 | one
 2 | two
 3 | three
 4 | four
 5 | five
(5 rows)

-- Check file count before vacuum
SELECT count(*)
FROM ducklake.ducklake_data_file ddf
JOIN ducklake.ducklake_table dt ON ddf.table_id = dt.table_id
JOIN ducklake.ducklake_schema ds ON dt.schema_id = ds.schema_id
WHERE dt.table_name = 'vacuum_merge'
  AND ds.schema_name = 'public'
  AND ddf.end_snapshot IS NULL;
 count 
-------
     5
(1 row)

-- Should trigger ducklake_merge_adjacent_files
VACUUM VERBOSE vacuum_merge;
INFO:  vacuuming ducklake table "public.vacuum_merge"
INFO:  rewritten data files with deleted rows
INFO:  merged adjacent small files
SELECT * FROM vacuum_merge ORDER BY a;
 a |   b   
---+-------
 1 | one
 2 | two
 3 | three
 4 | four
 5 | five
(5 rows)

-- Check file count after vacuum
SELECT count(*)
FROM ducklake.ducklake_data_file ddf
JOIN ducklake.ducklake_table dt ON ddf.table_id = dt.table_id
JOIN ducklake.ducklake_schema ds ON dt.schema_id = ds.schema_id
WHERE dt.table_name = 'vacuum_merge'
  AND ds.schema_name = 'public'
  AND ddf.end_snapshot IS NULL;
 count 
-------
     1
(1 row)

DROP TABLE vacuum_merge;
-- Scenario 2: Rewrite data files
CREATE TABLE vacuum_rewrite (a int, b text) USING ducklake;
INSERT INTO vacuum_rewrite SELECT i, 'val' || i FROM generate_series(1, 100) i;
-- Trigger rewrite threshold
DELETE FROM vacuum_rewrite WHERE a <= 20;
SELECT count(*) FROM vacuum_rewrite;
 count 
-------
    80
(1 row)

-- Check file count before vacuum
SELECT count(*)
FROM ducklake.ducklake_data_file ddf
JOIN ducklake.ducklake_table dt ON ddf.table_id = dt.table_id
JOIN ducklake.ducklake_schema ds ON dt.schema_id = ds.schema_id
WHERE dt.table_name = 'vacuum_rewrite'
  AND ds.schema_name = 'public'
  AND ddf.end_snapshot IS NULL;
 count 
-------
     1
(1 row)

-- Check delete file count before vacuum (should be > 0)
SELECT count(*)
FROM ducklake.ducklake_delete_file ddf
JOIN ducklake.ducklake_table dt ON ddf.table_id = dt.table_id
JOIN ducklake.ducklake_schema ds ON dt.schema_id = ds.schema_id
WHERE dt.table_name = 'vacuum_rewrite'
  AND ds.schema_name = 'public'
  AND ddf.end_snapshot IS NULL;
 count 
-------
     1
(1 row)

-- Should trigger ducklake_rewrite_data_files
VACUUM VERBOSE vacuum_rewrite;
INFO:  vacuuming ducklake table "public.vacuum_rewrite"
INFO:  rewritten data files with deleted rows
INFO:  merged adjacent small files
SELECT count(*) FROM vacuum_rewrite;
 count 
-------
    80
(1 row)

-- Check file count after vacuum
SELECT count(*)
FROM ducklake.ducklake_data_file ddf
JOIN ducklake.ducklake_table dt ON ddf.table_id = dt.table_id
JOIN ducklake.ducklake_schema ds ON dt.schema_id = ds.schema_id
WHERE dt.table_name = 'vacuum_rewrite'
  AND ds.schema_name = 'public'
  AND ddf.end_snapshot IS NULL;
 count 
-------
     1
(1 row)

-- Check delete file count after vacuum (should be 0)
SELECT count(*)
FROM ducklake.ducklake_delete_file ddf
JOIN ducklake.ducklake_table dt ON ddf.table_id = dt.table_id
JOIN ducklake.ducklake_schema ds ON dt.schema_id = ds.schema_id
WHERE dt.table_name = 'vacuum_rewrite'
  AND ds.schema_name = 'public'
  AND ddf.end_snapshot IS NULL;
 count 
-------
     0
(1 row)

DROP TABLE vacuum_rewrite;
